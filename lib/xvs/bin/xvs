#! sh

set -e
set -u
set -x

if [ -z "${__XVS_RUNTIME_STATE-}" ]
then
fi
export __XVS_RUNTIME_STATE="active"

export _XVS_PROFILE_NAME=${XVS_PROFILE-development}
export _XVS_SYSTEM_PROFILE_NAME=${XVS_SYSTEM_PROFILE-development}

export __XVS_SYSTEM_RUNTIME_STATE_EXECUTION_RECURSION_DEPTH=$((${_XVS_SYSTEM_RUNTIME_STATE_EXECUTION_RECURSION_DEPTH-0}+1))
export _XVS_SYSTEM_RUNTIME_STATE_EXECUTION_RECURSION_DEPTH=${__XVS_SYSTEM_RUNTIME_STATE_EXECUTION_RECURSION_DEPTH}

if [ ${_XVS_SYSTEM_RUNTIME_STATE_EXECUTION_RECURSION_DEPTH} -gt 1023 ]; then
  echo "Error: execution recursion depth limit exceeded"
  exit 254
fi

export __XVS_PROJECT_DIR_BIN_PATH="$(cd "$(dirname "$(readlink "$0" || echo "$0")")" && pwd)"

export __XVS_PROJECT_DIR_PATH="${__XVS_PROJECT_DIR_BIN_PATH}/.."

export __XVS_PROJECT_DIR_LIBEXEC_NAME="libexec"
export __XVS_PROJECT_DIR_LIBEXEC_PATH="${__XVS_PROJECT_DIR_PATH}/${__XVS_PROJECT_DIR_LIBEXEC_NAME}"

export __XVS_PROJECT_BOOTSTRAP_DIR_ROOT_NAME="bootstrap"
export __XVS_PROJECT_BOOTSTRAP_DIR_ROOT_PATH="${__XVS_PROJECT_DIR_LIBEXEC_PATH}/${__XVS_PROJECT_BOOTSTRAP_DIR_ROOT_NAME}"

export __XVS_PROJECT_BOOTSTRAP_DIR_LIBEXEC_NAME="libexec"
export __XVS_PROJECT_BOOTSTRAP_DIR_LIBEXEC_PATH="${__XVS_PROJECT_DIR_ROOT_PATH}/${__XVS_PROJECT_BOOTSTRAP_DIR_LIBEXEC_NAME}"

export __XVS_PROJECT_DIR_XVS_PATH="${__XVS_PROJECT_DIR_PATH}/.xvs"
export __XVS_PROJECT_DIR_XVS_SYSTEM_PATH="${__XVS_PROJECT_DIR_XVS_PATH}/system"
export __XVS_PROJECT_DIR_XVS_SYSTEM_TARGET_PATH="${__XVS_PROJECT_DIR_XVS_SYSTEM_PATH}/target"

export __XVS_TARGET_DIR_PATH="$(dirname "$0")"

export __XVS_TARGET_DIR_XVS_NAME=".xvs"
export __XVS_TARGET_DIR_XVS_PATH="${__XVS_TARGET_DIR_PATH}/${__XVS_TARGET_DIR_XVS_NAME}"

export __XVS_TARGET_DIR_XVS_LOCAL_NAME="local"
export __XVS_TARGET_DIR_XVS_LOCAL_PATH="${__XVS_TARGET_DIR_XVS_PATH}/${__XVS_TARGET_DIR_XVS_LOCAL_NAME}"

export __XVS_TARGET_DIR_XVS_SYSTEM_NAME="system"
export __XVS_TARGET_DIR_XVS_SYSTEM_PATH="${__XVS_TARGET_DIR_XVS_PATH}/${__XVS_TARGET_DIR_XVS_SYSTEM_NAME}"

export __XVS_TARGET_DIR_XVS_SYSTEM_CONTROL_NAME="control"
export __XVS_TARGET_DIR_XVS_SYSTEM_CONTROL_PATH="${__XVS_TARGET_DIR_XVS_SYSTEM_PATH}/${__XVS_TARGET_DIR_XVS_SYSTEM_CONTROL_NAME}"

export __XVS_TARGET_DIR_XVS_SYSTEM_CONTROL_BOOTSTRAP_FLAG_NAME="bootstrap"
export __XVS_TARGET_DIR_XVS_SYSTEM_CONTROL_BOOTSTRAP_FLAG_PATH="${__XVS_TARGET_DIR_XVS_SYSTEM_CONTROL_PATH}/${__XVS_TARGET_DIR_XVS_SYSTEM_CONTROL_BOOTSTRAP_FLAG_NAME}"

export __XVS_RUNTIME_STATE_EXECUTED_EXECUTABLE_NAME="$(basename ${0})"

if [ "${_XVS_SYSTEM_PROFILE_NAME}" = "development" ] || [ ! -f "${__XVS_TARGET_DIR_XVS_SYSTEM_CONTROL_BOOTSTRAP_FLAG_PATH}" ]; then
  exec "${__XVS_PROJECT_BOOTSTRAP_DIR_LIBEXEC_PATH}/${__XVS_RUNTIME_STATE_EXECUTED_EXECUTABLE_NAME}" $@
fi

exec ${__XVS_PROJECT_LIBEXEC_PATH}/${__XVS_RUNTIME_STATE_EXECUTED_EXECUTABLE_NAME} $@
