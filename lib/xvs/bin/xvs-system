#! /usr/bin/env nix-shell
#! nix-shell -i bash -p bash

set -e
set -u

export __XVS_RUNTIME_BUILD_PROFILE=${__XVS_RUNTIME_BUILD_PROFILE:-debug}

__XVS_EXECUTABLE_RUNTIME_NAME="xvs"
__XVS_EXECUTABLE_RUNTIME_SYSTEM_BOOTSTRAP_NAME="xvs-bootstrap"

__XVS_PROJECT_BIN_PATH=$(cd "$(dirname "$(readlink "$0" || echo "$0")")" && pwd)
export __XVS_PROJECT_PATH="${__XVS_PROJECT_BIN_PATH}/.."

__XVS_PROJECT_OUT_PATH="${__XVS_PROJECT_PATH}/out"
__XVS_PROJECT_OUT_BIN_PATH="${__XVS_PROJECT_OUT_PATH}/bin"

__XVS_PROJECT_LIB_PATH="${__XVS_PROJECT_PATH}/lib"
__XVS_PROJECT_LIB_BOOTSTRAP_PATH="${__XVS_PROJECT_LIB_PATH}/bootstrap"

__XVS_EXECUTABLE_RUNTIME_PATH="${__XVS_PROJECT_OUT_BIN_PATH}/${__XVS_EXECUTABLE_RUNTIME_NAME}"
__XVS_EXECUTABLE_RUNTIME_SYSTEM_BOOTSTRAP_PATH="${__XVS_PROJECT_LIB_BOOTSTRAP_PATH}/${__XVS_EXECUTABLE_RUNTIME_SYSTEM_BOOTSTRAP_NAME}"

if [[ $# -ge 1 && $1 == "system-rebuild" ]]
then

  echo "XVS RE-Bootstrapping"
  exec "${__XVS_EXECUTABLE_RUNTIME_SYSTEM_BOOTSTRAP_PATH}" rebootstrap

else

  if [[ ( ! -e "${__XVS_EXECUTABLE_RUNTIME_PATH}" ) || ${__XVS_RUNTIME_BUILD_PROFILE} == "debug" ]]
  then
    if [[ ${__XVS_RUNTIME_BUILD_PROFILE} == "debug" ]]
    then
      "${__XVS_EXECUTABLE_RUNTIME_SYSTEM_BOOTSTRAP_PATH}" rebootstrap
    else
      "${__XVS_EXECUTABLE_RUNTIME_SYSTEM_BOOTSTRAP_PATH}" bootstrap
    fi
  fi

  exec "${__XVS_EXECUTABLE_RUNTIME_PATH}"

fi
