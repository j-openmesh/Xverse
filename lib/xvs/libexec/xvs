#! /usr/bin/env sh

set -e
set -u

export __XVS_RUNTIME_BUILD_PROFILE_DEFAULT="development"
export _XVS_RUNTIME_BUILD_PROFILE=${_XVS_RUNTIME_BUILD_PROFILE-${__XVS_RUNTIME_BUILD_PROFILE_DEFAULT}}

__XVS_PROJECT_LIBEXEC_PATH="$(cd "$(dirname "$(readlink "$0" || echo "$0")")" && pwd)"

__XVS_PROJECT_ROOT_PATH=${__XVS_PROJECT_LIBEXEC_PATH}/..

__XVS_PROJECT_OUT_PATH=${__XVS_PROJECT_ROOT_PATH}/out
__XVS_PROJECT_OUT_BIN_PATH=${__XVS_PROJECT_OUT_PATH}/bin

__XVS_PROJECT_LIB_PATH=${__XVS_PROJECT_ROOT_PATH}/lib
__XVS_PROJECT_LIB_BOOTSTRAP_PATH=${__XVS_PROJECT_LIB_PATH}/bootstrap

__XVS_SYSTEM_RUNTIME_EXECUTABLE_NAME=xvs
__XVS_SYSTEM_RUNTIME_EXECUTABLE_PATH=${__XVS_PROJECT_OUT_BIN_PATH}/${__XVS_SYSTEM_RUNTIME_EXECUTABLE_NAME}

if [[ ( ! -e ${__XVS_SYSTEM_RUNTIME_EXECUTABLE_PATH} ) || ${_XVS_RUNTIME_BUILD_PROFILE} == "development" ]]; then
   make clean build
fi

exec ${__XVS_SYSTEM_RUNTIME_EXECUTABLE_PATH} $@
