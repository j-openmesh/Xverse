#! /usr/bin/env nix-shell
#! nix-shell -i bash -p bash -p gnumake

set -e
set -u

__XVS_SYSTEM_BOOTSTRAP_RUNTIME_STRAP_TARGET="bootstrap"
__XVS_SYSTEM_BOOTSTRAP_RUNTIME_RESTRAP_TARGET="rebootstrap"
__XVS_SYSTEM_BOOTSTRAP_BUILDER_PATH="$(which make)"

__XVS_PROJECT_LIB_BOOTSTRAP_PATH=$(cd "$(dirname "$(readlink "$0" || echo "$0")")" && pwd)
__XVS_PROJECT_PATH="${__XVS_PROJECT_LIB_BOOTSTRAP_PATH}/../.."
__XVS_SYSTEM_BOOTSTRAP_BUILDER_PROGRAM_PATH="${__XVS_PROJECT_PATH}/Makefile"

if [[ $# -gt 1 && ${1} == "force" ]]
then
  exec "${__XVS_SYSTEM_BOOTSTRAP_BUILDER_PATH}" -s -f "${__XVS_SYSTEM_BOOTSTRAP_BUILDER_PROGRAM_PATH}" -C "${__XVS_PROJECT_PATH}" "${__XVS_SYSTEM_BOOTSTRAP_RUNTIME_TARGET}"
else
  exec "${__XVS_SYSTEM_BOOTSTRAP_BUILDER_PATH}" -s -f "${__XVS_SYSTEM_BOOTSTRAP_BUILDER_PROGRAM_PATH}" -C "${__XVS_PROJECT_PATH}" "${__XVS_SYSTEM_BOOTSTRAP_RUNTIME_RESTRAP_TARGET}"
fi
